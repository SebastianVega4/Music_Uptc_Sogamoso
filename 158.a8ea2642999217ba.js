"use strict";(self.webpackChunkuptc_music=self.webpackChunkuptc_music||[]).push([[158],{3824:(U,f,e)=>{e.d(f,{U:()=>d});var g=e(4412),v=e(6276);let d=(()=>{class h{audio;currentUrlSubject=new g.t(null);isPlayingSubject=new g.t(!1);currentUrl$=this.currentUrlSubject.asObservable();isPlaying$=this.isPlayingSubject.asObservable();constructor(){this.audio=new Audio,this.audio.addEventListener("ended",()=>{this.stop()}),this.audio.addEventListener("pause",()=>{this.isPlayingSubject.next(!1)}),this.audio.addEventListener("play",()=>{this.isPlayingSubject.next(!0)})}play(n){console.log("AudioService: Request to play",n),n?this.currentUrlSubject.value===n?this.audio.paused?(console.log("AudioService: Resuming audio"),this.audio.play().catch(o=>console.error("AudioService: Error resuming:",o))):(console.log("AudioService: Pausing audio"),this.audio.pause()):(console.log("AudioService: Playing new song"),this.stop(),this.audio.src=n,this.audio.load(),this.audio.play().then(()=>console.log("AudioService: Playback started")).catch(o=>console.error("AudioService: Error playing audio:",o)),this.currentUrlSubject.next(n)):console.warn("AudioService: No URL provided")}pause(){this.audio.pause()}stop(){this.audio.pause(),this.audio.currentTime=0,this.currentUrlSubject.next(null),this.isPlayingSubject.next(!1)}isCurrentSong(n){return!!n&&this.currentUrlSubject.value===n}static \u0275fac=function(o){return new(o||h)};static \u0275prov=v.jDH({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})()},6181:(U,f,e)=>{e.d(f,{F:()=>n});var g=e(9437),v=e(5312),d=e(6276),h=e(1626),_=e(3205);let n=(()=>{class o{http;authService;apiUrl=v.c.apiUrl;constructor(p,u){this.http=p,this.authService=u}getQueue(){const p=this.authService.getAuthHeaders();return this.http.get(`${this.apiUrl}/api/spotify/admin/queue`,{headers:p})}getNextSong(){return this.http.get(`${this.apiUrl}/api/spotify/queue/next`)}addToQueue(p){const u=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/queue`,{uri:p},{headers:u}).pipe((0,g.W)(l=>{console.error("Error adding to queue:",l);let i="Error desconocido al agregar a la cola";throw l.error?.error?i=l.error.error:401===l.status?i="No autorizado - verifica la conexi\xf3n de Spotify":404===l.status&&(i="Dispositivo de Spotify no encontrado"),new Error(i)}))}static \u0275fac=function(u){return new(u||o)(d.KVO(h.Qq),d.KVO(_.u))};static \u0275prov=d.jDH({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})()},878:(U,f,e)=>{e.d(f,{K:()=>u});var g=e(8810),v=e(605),d=e(5312),h=e(9437),_=e(5558),n=e(9172),o=e(6276),E=e(1626),p=e(3205);let u=(()=>{class l{http;authService;apiUrl=d.c.apiUrl;automaticCheckInterval=null;constructor(t,s){this.http=t,this.authService=s,this.startAutomaticPlayingSongCheck(5e3)}getCacheBustedUrl(t){return`${t}?_=${(new Date).getTime()}`}startAutomaticPlayingSongCheck(t=3e4){this.stopAutomaticPlayingSongCheck(),this.automaticCheckInterval=setInterval(()=>{this.checkAndRemovePlayingSongFromRanking().subscribe({next:s=>{s.deleted&&alert(`Canci\xf3n eliminada autom\xe1ticamente del ranking: ${s.song.name}`)},error:s=>{401===s.status||console.error("Error en verificaci\xf3n autom\xe1tica:",s)}})},t)}playTrack(t){const s=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/play`,{uri:t},{headers:s})}pausePlayback(){const t=this.authService.getAuthHeaders();return this.http.put(`${this.apiUrl}/api/spotify/admin/pause`,{},{headers:t})}resumePlayback(){const t=this.authService.getAuthHeaders();return this.http.put(`${this.apiUrl}/api/spotify/admin/resume`,{},{headers:t})}nextTrack(){const t=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/next`,{},{headers:t})}previousTrack(){const t=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/previous`,{},{headers:t})}stopAutomaticPlayingSongCheck(){this.automaticCheckInterval&&(clearInterval(this.automaticCheckInterval),this.automaticCheckInterval=null)}getAdminCurrentlyPlaying(){const t=this.getCacheBustedUrl(`${this.apiUrl}/api/spotify/admin/currently-playing`);return this.http.get(t).pipe((0,h.W)(s=>401===s.status?this.refreshAdminToken().pipe((0,_.n)(()=>{const y=this.getCacheBustedUrl(`${this.apiUrl}/api/spotify/admin/currently-playing`);return this.http.get(y)}),(0,h.W)(y=>(console.error("Error al refrescar token:",y),(0,g.$)(()=>y)))):(0,g.$)(()=>s)))}refreshAdminToken(){const t=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/refresh-token`,{},{headers:t})}getAdminCurrentlyPlayingPolling(){return(0,v.Y)(3e3).pipe((0,n.Z)(0),(0,_.n)(()=>this.getAdminCurrentlyPlaying()))}getAdminSpotifyStatus(){const t=this.getCacheBustedUrl(`${this.apiUrl}/api/spotify/admin/status`);return this.http.get(t)}startAdminSpotifyAuth(){const t=this.getCacheBustedUrl(`${this.apiUrl}/api/spotify/admin/auth`);return this.http.get(t)}disconnectAdminSpotify(){const t=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/disconnect`,{},{headers:t})}startSpotifyAuth(){const t=this.getCacheBustedUrl(`${this.apiUrl}/api/spotify/auth`);return this.http.get(t)}getCurrentlyPlaying(){const t=this.getCacheBustedUrl(`${this.apiUrl}/api/spotify/currently-playing`);return this.http.get(t)}getCurrentlyPlayingPolling(){return(0,v.Y)(3e3).pipe((0,n.Z)(0),(0,_.n)(()=>this.getCurrentlyPlaying()))}addToQueue(t){const s=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/queue`,{uri:t},{headers:s})}checkAndRemovePlayingSongFromRanking(t=!1){const s=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/check-playing-song`,{force_add:t},{headers:s})}getQueue(){const t=this.authService.getAuthHeaders();return this.http.get(`${this.apiUrl}/api/spotify/admin/queue`,{headers:t})}addToHistory(){const t=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/add-to-history`,{},{headers:t})}addToHistoryConfirmed(){const t=this.authService.getAuthHeaders();return this.http.post(`${this.apiUrl}/api/spotify/admin/add-to-history-confirmed`,{},{headers:t})}static \u0275fac=function(s){return new(s||l)(o.KVO(E.Qq),o.KVO(p.u))};static \u0275prov=o.jDH({token:l,factory:l.\u0275fac,providedIn:"root"})}return l})()},5905:(U,f,e)=>{e.d(f,{e:()=>_});var g=e(6354),v=e(5312),d=e(6276),h=e(1626);let _=(()=>{class n{http;apiUrl=v.c.apiUrl;constructor(E){this.http=E}searchTracks(E){return this.http.get(`${this.apiUrl}/api/search?q=${encodeURIComponent(E)}`).pipe((0,g.T)(p=>p.map(u=>({id:u.id,name:u.name,artists:u.artists,album:u.album,image:u.image,preview_url:u.preview_url,duration_ms:u.duration_ms}))))}getAuthUrl(){return this.http.get(`${this.apiUrl}/api/spotify/auth`)}getCurrentlyPlaying(){return this.http.get(`${this.apiUrl}/api/spotify/currently-playing`)}getStatus(){return this.http.get(`${this.apiUrl}/api/spotify/admin/status`)}static \u0275fac=function(p){return new(p||n)(d.KVO(h.Qq))};static \u0275prov=d.jDH({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})()},1180:(U,f,e)=>{e.d(f,{Z:()=>t});var g=e(605),v=e(7673),d=e(8810),h=e(8141),_=e(9172),n=e(5558),o=e(6354),E=e(9437),p=e(5312),u=e(6276),l=e(1626),i=e(3205);let t=(()=>{class s{http;authService;apiUrl=p.c.apiUrl;cachedSongs=[];lastFetchTime=0;CACHE_DURATION=2e3;cachedVotingStatus=null;lastVotingStatusFetch=0;constructor(r,a){this.http=r,this.authService=a}getCacheBustedUrl(r){const a=r.includes("?")?"&":"?";return`${r}${a}_=${(new Date).getTime()}`}invalidateCache(){this.cachedSongs=[],this.lastFetchTime=0}invalidateVotingStatusCache(){this.cachedVotingStatus=null,this.lastVotingStatusFetch=0}processSongs(r){return r&&0!==r.length?r.sort((a,c)=>a.votes>c.votes?-1:a.votes<c.votes?1:new Date(c.createdat).getTime()-new Date(a.createdat).getTime()):[]}voteForSong(r,a,c=!1,m=""){return this.http.post(`${this.apiUrl}/api/vote`,{trackid:r,trackInfo:a,is_dislike:c,dedication:m}).pipe((0,h.M)(()=>{this.invalidateCache()}))}changeVote(r,a,c){return this.voteForSong(r,a,c)}getRankedSongsPolling(){return(0,g.Y)(3e4).pipe((0,_.Z)(0),(0,n.n)(()=>this.getRankedSongs()))}getRankedSongs(){const r=Date.now();if(this.cachedSongs.length>0&&r-this.lastFetchTime<this.CACHE_DURATION)return(0,v.of)([...this.cachedSongs]);const a=this.getCacheBustedUrl(`${this.apiUrl}/api/votes`);return this.http.get(a).pipe((0,o.T)(c=>{const m=this.processSongs(c||[]);return this.cachedSongs=m,this.lastFetchTime=r,m}))}getRecentlyAddedSongs(){return this.getRankedSongs().pipe((0,o.T)(r=>[...r].sort((a,c)=>new Date(c.createdat).getTime()-new Date(a.createdat).getTime()).slice(0,10)))}getSongs(){return this.getRankedSongs()}addToHistory(r){return this.http.post(`${this.apiUrl}/spotify/history`,{trackId:r})}vote(r,a,c=!1){return this.http.post(`${this.apiUrl}/vote`,{song:r,isDislike:a,isAdmin:c})}deleteSong(r){const a=this.authService.getAuthHeaders(),m=this.getCacheBustedUrl(`${this.apiUrl}/api/votes?trackid=${r}`);return this.http.delete(m,{headers:a}).pipe((0,h.M)(()=>{this.invalidateCache()}))}deleteAllVotes(){const r=this.authService.getAuthHeaders(),a=this.getCacheBustedUrl(`${this.apiUrl}/api/votes/all`);return this.http.delete(a,{headers:r}).pipe((0,h.M)(()=>{this.invalidateCache()}))}forceRefresh(){this.invalidateCache();const r=this.getCacheBustedUrl(`${this.apiUrl}/api/votes`);return this.http.get(r).pipe((0,o.T)(a=>{const c=this.processSongs(a||[]);return this.cachedSongs=c,this.lastFetchTime=Date.now(),c}))}getRankedSongsImmediate(){const r=this.getCacheBustedUrl(`${this.apiUrl}/api/votes`);return this.http.get(r).pipe((0,o.T)(a=>this.processSongs(a||[])))}getVotingStatus(){const r=this.getCacheBustedUrl(`${this.apiUrl}/api/voting/status`);return this.http.get(r)}submitVote(r){return this.http.post(`${this.apiUrl}/api/voting/vote`,{vote_type:r}).pipe((0,h.M)(()=>{this.invalidateVotingStatusCache()}),(0,E.W)(a=>{let c="Error al votar";return a.error?.error?c=a.error.error:400===a.status?c="Solicitud incorrecta":409===a.status?c=a.error?.error||"Ya has votado por esta opci\xf3n":500===a.status?c="Error del servidor":0===a.status&&(c="Error de conexi\xf3n"),this.invalidateVotingStatusCache(),(0,d.$)(()=>new Error(c))}))}getVotingStatusImmediate(){const r=this.getCacheBustedUrl(`${this.apiUrl}/api/voting/status`);return this.http.get(r)}static \u0275fac=function(a){return new(a||s)(u.KVO(l.Qq),u.KVO(i.u))};static \u0275prov=u.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})()},605:(U,f,e)=>{e.d(f,{Y:()=>d});var g=e(3888),v=e(1584);function d(h=0,_=g.E){return h<0&&(h=0),(0,v.O)(h,h,_)}},1584:(U,f,e)=>{e.d(f,{O:()=>_});var g=e(1985),v=e(3888),d=e(9470);function _(n=0,o,E=v.b){let p=-1;return null!=o&&((0,d.m)(o)?E=o:p=o),new g.c(u=>{let l=function h(n){return n instanceof Date&&!isNaN(n)}(n)?+n-E.now():n;l<0&&(l=0);let i=0;return E.schedule(function(){u.closed||(u.next(i++),0<=p?this.schedule(void 0,p):u.complete())},l)})}},3888:(U,f,e)=>{e.d(f,{b:()=>u,E:()=>p});var g=e(8359);class v extends g.yU{constructor(i,t){super()}schedule(i,t=0){return this}}const d={setInterval(l,i,...t){const{delegate:s}=d;return s?.setInterval?s.setInterval(l,i,...t):setInterval(l,i,...t)},clearInterval(l){const{delegate:i}=d;return(i?.clearInterval||clearInterval)(l)},delegate:void 0};var h=e(7908);const n={now:()=>(n.delegate||Date).now(),delegate:void 0};class o{constructor(i,t=o.now){this.schedulerActionCtor=i,this.now=t}schedule(i,t=0,s){return new this.schedulerActionCtor(this,i).schedule(s,t)}}o.now=n.now;const p=new class E extends o{constructor(i,t=o.now){super(i,t),this.actions=[],this._active=!1}flush(i){const{actions:t}=this;if(this._active)return void t.push(i);let s;this._active=!0;do{if(s=i.execute(i.state,i.delay))break}while(i=t.shift());if(this._active=!1,s){for(;i=t.shift();)i.unsubscribe();throw s}}}(class _ extends v{constructor(i,t){super(i,t),this.scheduler=i,this.work=t,this.pending=!1}schedule(i,t=0){var s;if(this.closed)return this;this.state=i;const y=this.id,r=this.scheduler;return null!=y&&(this.id=this.recycleAsyncId(r,y,t)),this.pending=!0,this.delay=t,this.id=null!==(s=this.id)&&void 0!==s?s:this.requestAsyncId(r,this.id,t),this}requestAsyncId(i,t,s=0){return d.setInterval(i.flush.bind(i,this),s)}recycleAsyncId(i,t,s=0){if(null!=s&&this.delay===s&&!1===this.pending)return t;null!=t&&d.clearInterval(t)}execute(i,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;const s=this._execute(i,t);if(s)return s;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(i,t){let y,s=!1;try{this.work(i)}catch(r){s=!0,y=r||new Error("Scheduled action threw falsy error")}if(s)return this.unsubscribe(),y}unsubscribe(){if(!this.closed){const{id:i,scheduler:t}=this,{actions:s}=t;this.work=this.state=this.scheduler=null,this.pending=!1,(0,h.o)(s,this),null!=i&&(this.id=this.recycleAsyncId(t,i,null)),this.delay=null,super.unsubscribe()}}}),u=p}}]);