<div class="ranking-container fade-in">
  <!-- Mensajes de estado -->
  <div class="message-container">
    <div class="success-message" *ngIf="voteMessage">
      {{ voteMessage }}
    </div>
  </div>
  <div class="header-section">
    <h1 class="gradient-text">
      <i class="fas fa-trophy me-2"></i>Ranking Histórico
    </h1>
    <p class="text-muted">
      Descubre las canciones más populares que han sonado en nuestro restaurante
    </p>
  </div>

  <!-- Estadísticas generales -->
  <div class="stats-grid mb-4">
    <div class="stat-card card">
      <div class="card-body text-center">
        <i class="fas fa-music stat-icon"></i>
        <h3 class="stat-value">{{ stats.totalSongs || 0 }}</h3>
        <p class="stat-label">Canciones totales</p>
      </div>
    </div>
    <div class="stat-card card">
      <div class="card-body text-center">
        <i class="fas fa-play-circle stat-icon"></i>
        <h3 class="stat-value">{{ stats.totalPlays || 0 }}</h3>
        <p class="stat-label">Reproducciones</p>
      </div>
    </div>
    <div class="stat-card card">
      <div class="card-body text-center">
        <i class="fas fa-thumbs-up stat-icon"></i>
        <h3 class="stat-value">{{ stats.totalVotes || 0 }}</h3>
        <p class="stat-label">Votos positivos</p>
      </div>
    </div>
    <div class="stat-card card">
      <div class="card-body text-center">
        <i class="fas fa-thumbs-down stat-icon"></i>
        <h3 class="stat-value">{{ stats.totalDislikes || 0 }}</h3>
        <p class="stat-label">Votos negativos</p>
      </div>
    </div>
  </div>

  <!-- Pestañas de navegación -->
  <div class="tabs-container mb-4">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'all'" (click)="setActiveTab('all')">
          <i class="fas fa-list me-1"></i>Todas
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'mostPlayed'" (click)="setActiveTab('mostPlayed')">
          <i class="fas fa-play-circle me-1"></i>Más reproducidas
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'mostVoted'" (click)="setActiveTab('mostVoted')">
          <i class="fas fa-thumbs-up me-1"></i>Más votadas
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="activeTab === 'bestRated'" (click)="setActiveTab('bestRated')">
          <i class="fas fa-star me-1"></i>Mejor valoradas
        </a>
      </li>
    </ul>
  </div>

  <!-- Filtros y ordenamiento -->
  <div class="filters-card card mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-6 mb-3 mb-md-0">
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Buscar canción o artista..." [(ngModel)]="filterText">
            <button class="search-clear" *ngIf="filterText" (click)="filterText = ''">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <p class="text-muted">Preciona la cacion para ver los detallas </p>
        </div>
        <div class="col-md-6">
          <div class="d-flex flex-wrap gap-2 justify-content-md-end">
            <span class="text-muted me-2">Ordenar por:</span>
            <button class="btn btn-sm btn-outline-secondary" (click)="onSortChange('times_played')">
              <i class="fas fa-play-circle me-1"></i>
              Reproducciones
              <i class="fas {{getSortIcon('times_played')}} ms-1"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="onSortChange('total_votes')">
              <i class="fas fa-thumbs-up me-1"></i>
              Votos
              <i class="fas {{getSortIcon('total_votes')}} ms-1"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="onSortChange('last_played_at')">
              <i class="fas fa-calendar me-1"></i>
              Fecha
              <i class="fas {{getSortIcon('last_played_at')}} ms-1"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
  </div>

  <!-- Loading state -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="loading-spinner mb-3"></div>
    <p class="text-muted">Cargando ranking histórico...</p>
  </div>

  <!-- Lista de canciones -->
  <div *ngIf="!isLoading && getTabSongs().length > 0" class="songs-grid">
    <div *ngFor="let song of getTabSongs(); let i = index" class="song-card spotify-card">
      <div class="card-content">
        <!-- Imagen con número de posición superpuesto -->
        <div class="song-image-container" (click)="onShowDetails(song)">
          <span class="position-number">{{ i + 1 }}</span>
          <img [src]="song.image || 'assets/default-song.png'" [alt]="song.name" class="song-image"
            (click)="onShowDetails(song)">
        </div>

        <!-- Información de la canción -->
        <div class="song-info">
          <h3 class="song-title" (click)="onShowDetails(song)">{{ song.name }}</h3>
          <p class="song-artist" (click)="onShowDetails(song)">{{ song.artists.join(', ') }}</p>

          <!-- Estadísticas compactas -->
          <div class="song-stats" (click)="onShowDetails(song)">
            <span class="stat-item">
              <i class="fas fa-play"></i> {{ song.times_played }}
            </span>
            <span class="stat-item">
              <i class="fas fa-thumbs-up"></i> {{ song.total_votes }}
            </span>
            <span class="stat-item">
              <i class="fas fa-thumbs-down"></i> {{ song.total_dislikes }}
            </span>
          </div>

          <!-- Barra de progreso de aprobación -->
          <div class="approval-container" (click)="onShowDetails(song)">
            <div class="approval-bar">
              <div class="approval-progress" [style.width.%]="getVotePercentage(song)"></div>
            </div>
            <span class="approval-text">{{ getVotePercentage(song) }}% aprobación</span>
          </div>
          <p class="last-played">{{ formatDate(song.last_played_at) }}</p>
          <button class="btn btn-primary w-100 mb-2" (click)="onVote(song)" [disabled]="isVoting">
            <i class="fas fa-vote-yea me-1" *ngIf="!isVoting"></i>
            <i class="fas fa-spinner fa-spin me-1" *ngIf="isVoting"></i>
            Votar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="!isLoading && getTabSongs().length === 0" class="text-center py-5">
    <i class="fas fa-music fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">No se encontraron canciones</h4>
    <p class="text-muted">Intenta con otros términos de búsqueda</p>
  </div>

  <!-- Modal de detalles -->
  <div *ngIf="selectedSong" class="modal-backdrop show" (click)="onCloseDetails()"></div>
  <div *ngIf="selectedSong" class="modal show d-block" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content card">
        <div class="modal-header card-header">
          <h5 class="modal-title">
            <i class="fas fa-info-circle me-2"></i>Detalles de la Canción
          </h5>
          <button type="button" class="btn btn-primary w-100 mb-2" (click)="onCloseDetails()">
            Cerrar </button>
        </div>
        <div class="modal-body card-body">
          <div class="row">
            <div class="col-md-4 text-center">
              <img [src]="selectedSong.image || 'assets/default-song.png'" [alt]="selectedSong.name"
                class="img-fluid rounded mb-3">
              <button class="btn btn-primary w-100 mb-2" (click)="onVote(selectedSong)" [disabled]="isVoting">
                <i class="fas fa-vote-yea me-1" *ngIf="!isVoting"></i>
                <i class="fas fa-spinner fa-spin me-1" *ngIf="isVoting"></i>
                Votar por esta canción
              </button>
            </div>
            <div class="col-md-8">
              <h4 class="text-muted">{{ selectedSong.name }}</h4>
              <p class="text-muted">{{ selectedSong.artists.join(', ') }}</p>

              <div class="row mt-4">
                <div class="col-6">
                  <div class="stat-box text-center p-3 rounded">
                    <h3 class="text-primary">{{ selectedSong.times_played }}</h3>
                    <p class="mb-0 text-muted">Reproducciones</p>
                  </div>
                </div>
                <div class="col-6">
                  <div class="stat-box text-center p-3 rounded">
                    <h3 class="text-success">{{ selectedSong.total_votes }}</h3>
                    <p class="mb-0 text-muted">Votos positivos</p>
                  </div>
                </div>
                <div class="col-6 mt-3">
                  <div class="stat-box text-center p-3 rounded">
                    <h3 class="text-danger">{{ selectedSong.total_dislikes }}</h3>
                    <p class="mb-0 text-muted">Votos negativos</p>
                  </div>
                </div>
                <div class="col-6 mt-3">
                  <div class="stat-box text-center p-3 rounded">
                    <h3 class="text-info">{{ getVotePercentage(selectedSong) }}%</h3>
                    <p class="mb-0 text-muted">Porcentaje de aprobación</p>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <h6 class="text-muted">Última reproducción</h6>
                <p class="text-muted">{{ formatDate(selectedSong.last_played_at) }}</p>

                <h6 class="text-muted">Días desde la última reproducción</h6>
                <p class="text-muted">{{ getDaysSinceLastPlayed(selectedSong) }} días</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>