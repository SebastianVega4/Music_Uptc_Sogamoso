<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-left">
        <h3>
          <i class="fas fa-comments me-2"></i>
          Chat Musical
        </h3>
        <div class="connection-status" [class.connected]="isConnected" [class.disconnected]="!isConnected">
          <span class="status-dot"></span>
          {{ isConnected ? 'Conectado' : 'Desconectado' }}
        </div>
      </div>
      
      <div class="header-right">
        <div class="online-users">
          <i class="fas fa-users me-1"></i>
          {{ onlineUsers }} online
        </div>
        <button class="btn-user" (click)="showUserModal = true" title="Cambiar usuario">
          <i class="fas fa-user-edit"></i>
        </button>
      </div>
    </div>
  
    <!-- Estadísticas -->
    <div class="chat-stats" *ngIf="stats">
      <div class="stat-item">
        <small>Total mensajes: {{ stats.total_messages }}</small>
      </div>
      <div class="stat-item">
        <small>Hoy: {{ stats.messages_today }}</small>
      </div>
    </div>
  
    <!-- Mensajes -->
    <div class="messages-container" #messagesContainer>
      <div *ngFor="let message of messages; trackBy: trackByMessage" 
           class="message" 
           [class.system-message]="message.type === 'system'"
           [class.own-message]="message.user === currentUser && message.type === 'message'">
        
        <div class="message-header" *ngIf="message.type === 'message'">
          <strong class="username">{{ message.user }}</strong>
          <span class="message-time">
            {{ formatDate(message.timestamp) }} {{ formatTime(message.timestamp) }}
          </span>
        </div>
        
        <div class="message-content">
          {{ message.message }}
        </div>
      </div>
  
      <!-- Indicador de escritura -->
      <div *ngIf="typingUsers.length > 0" class="typing-indicator">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="typing-text">
          {{ typingUsers.join(', ') }} 
          {{ typingUsers.length === 1 ? 'está escribiendo...' : 'están escribiendo...' }}
        </span>
      </div>
    </div>
  
    <!-- Input -->
    <div class="input-container">
      <input 
        #messageInput
        type="text" 
        [(ngModel)]="newMessage" 
        (input)="onInputChange()"
        (keyup.enter)="sendMessage()"
        [disabled]="!isConnected"
        placeholder="{{ isConnected ? 'Escribe un mensaje...' : 'Conectando...' }}" 
        class="message-input"
      />
      <button 
        (click)="sendMessage()" 
        [disabled]="!newMessage.trim() || !isConnected"
        class="send-button"
      >
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  
    <!-- Modal para cambiar usuario -->
    <div *ngIf="showUserModal" class="modal-overlay" (click)="showUserModal = false">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h4>Cambiar Nombre de Usuario</h4>
        <input 
          type="text" 
          [(ngModel)]="currentUser"
          (keyup.enter)="updateUser()"
          placeholder="Tu nombre de usuario"
          class="user-input"
        />
        <div class="modal-actions">
          <button class="btn-cancel" (click)="showUserModal = false">Cancelar</button>
          <button class="btn-save" (click)="updateUser()">Guardar</button>
        </div>
      </div>
    </div>
  </div>