<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Panel de Administración</h2>
  <button class="btn btn-outline-danger" (click)="logout()">
    <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesión
  </button>
</div>

<!-- Sección de Horarios -->
<div class="card mb-4" (click)="hideAnnouncement()">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Horarios de Música</h5>
    <button class="btn btn-sm" [class.btn-outline-primary]="!isEditingSchedules"
      [class.btn-primary]="isEditingSchedules" (click)="isEditingSchedules = !isEditingSchedules">
      <i class="fas" [class.fa-edit]="!isEditingSchedules" [class.fa-times]="isEditingSchedules"></i>
      {{ isEditingSchedules ? 'Cancelar' : 'Editar' }}
    </button>
  </div>
  <div class="card-body" *ngIf="!isHidden">
    <div *ngIf="!isEditingSchedules">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Día</th>
              <th>Almuerzo</th>
              <th>Cena</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let schedule of schedules; let i = index">
              <td><strong>{{ ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'][i] }}</strong></td>
              <td>{{ convertToAmPm(schedule.lunch_start) || '-' }} - {{ convertToAmPm(schedule.lunch_end) || '-' }}</td>
              <td>{{ convertToAmPm(schedule.dinner_start) || '-' }} - {{ convertToAmPm(schedule.dinner_end) || '-' }}
              </td>
              <td>
                <span class="badge" [class.bg-success]="schedule.is_active" [class.bg-secondary]="!schedule.is_active">
                  {{ schedule.is_active ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div *ngIf="isEditingSchedules">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Día</th>
              <th>Almuerzo (Inicio - Fin)</th>
              <th>Cena (Inicio - Fin)</th>
              <th>Activo</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let schedule of schedules; let i = index">
              <td><strong>{{ ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'][schedule.day_of_week] }}</strong>
              </td>
              <td>
                <div class="row g-2">
                  <div class="col">
                    <input type="time" class="form-control form-control-sm" [(ngModel)]="schedule.lunch_start">
                  </div>
                  <div class="col">
                    <input type="time" class="form-control form-control-sm" [(ngModel)]="schedule.lunch_end">
                  </div>
                </div>
              </td>
              <td>
                <div class="row g-2">
                  <div class="col">
                    <input type="time" class="form-control form-control-sm" [(ngModel)]="schedule.dinner_start">
                  </div>
                  <div class="col">
                    <input type="time" class="form-control form-control-sm" [(ngModel)]="schedule.dinner_end">
                  </div>
                </div>
              </td>
              <td>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="schedule.is_active">
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="btn btn-success mt-2" (click)="saveSchedules()">
        <i class="fas fa-save me-1"></i>Guardar Horarios
      </button>
    </div>
  </div>
</div>

<!-- Sección de Cola de Reproducción -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Cola de Reproducción</h5>
    <button class="btn btn-sm btn-outline-secondary" (click)="toggleQueue()">
      <i class="fas" [class.fa-eye]="!showQueue" [class.fa-eye-slash]="showQueue"></i>
      {{ showQueue ? 'Ocultar' : 'Mostrar' }} Cola
    </button>
  </div>
  <div class="card-body" *ngIf="showQueue">
    <div *ngIf="isLoadingQueue" class="text-center py-3">
      <i class="fas fa-spinner fa-spin fa-2x"></i>
      <p class="mt-2">Cargando cola de reproducción...</p>
    </div>

    <div *ngIf="!isLoadingQueue && queue.length === 0" class="alert alert-info">
      No hay canciones en la cola de reproducción.
    </div>

    <div *ngFor="let item of queue; let i = index" class="card mb-2">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-1 text-center">
            <span class="badge bg-primary rounded-pill">{{ i + 1 }}</span>
          </div>
          <div class="col-2">
            <img [src]="item.album?.images[0]?.url || 'https://placehold.co/60x60?text=No+Image'"
              class="img-fluid rounded" [alt]="item.name">
          </div>
          <div class="col-9">
            <h6 class="mb-1">{{ item.name }}</h6>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sección de Spotify Admin -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Configuración de Spotify</h5>
    <div class="update-button-container">
      <button class="btn btn-icon" (click)="getAdminCurrentlyPlaying()" title="Actualizar">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
  </div>
  <div class="card-body">
    <div *ngIf="spotifyStatus">
      <div *ngIf="spotifyStatus.authenticated && spotifyStatus.token_valid" class="alert alert-success">
        <i class="fab fa-spotify me-2"></i> Spotify conectado correctamente
        <button class="btn btn-sm btn-outline-danger ms-3" (click)="disconnectSpotify()">
          Desconectar
        </button>
      </div>

      <div *ngIf="!spotifyStatus.authenticated || !spotifyStatus.token_valid" class="alert alert-warning">
        <i class="fab fa-spotify me-2"></i> Spotify no conectado
        <button class="btn btn-sm btn-success ms-3" (click)="connectSpotify()">
          Conectar Spotify
        </button>
      </div>
    </div>

    <!-- Mostrar lo que se está reproduciendo actualmente en el admin -->
    <div *ngIf="adminCurrentlyPlaying && adminCurrentlyPlaying.is_playing" class="mt-3">
      <h6>Reproduciendo ahora (visible para todos):</h6>
      <div class="d-flex align-items-center">
        <img [src]="adminCurrentlyPlaying.image" class="img-thumbnail me-3" style="width: 60px; height: 60px;"
          [alt]="adminCurrentlyPlaying.name">
        <div>
          <strong>{{ adminCurrentlyPlaying.name }}</strong><br>
          <small class="text-muted">{{ adminCurrentlyPlaying.artists.join(', ') }}</small>
        </div>
      </div>
      
      <div class="btn-group mt-2">
        <button class="btn btn-warning btn-sm" (click)="checkPlayingSong()">
          <i class="fas fa-search me-1"></i>Verificar en ranking
        </button>
        <button class="btn btn-info btn-sm" (click)="addToHistory()">
          <i class="fas fa-history me-1"></i>Agregar al histórico
        </button>
      </div>
    </div>

    <div *ngIf="adminCurrentlyPlaying && !adminCurrentlyPlaying.is_playing" class="mt-3">
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i> No se está reproduciendo nada en Spotify
      </div>
    </div>
  </div>
</div>
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Canciones más votadas</h5>
    <div>
      <button class="btn btn-sm btn-outline-danger me-2" (click)="deleteAllVotes()">
        <i class="fas fa-trash me-1"></i>Eliminar Todos los Votos
      </button>
      <button class="btn btn-sm btn-outline-secondary" (click)="loadSongs()">
        <i class="fas fa-sync-alt"></i> Actualizar
      </button>
    </div>
  </div>
  
  <div class="card-body">
    <div *ngIf="isLoading" class="text-center py-3">
      <i class="fas fa-spinner fa-spin fa-2x"></i>
      <p class="mt-2">Cargando canciones...</p>
    </div>

    <div *ngIf="!isLoading && songs.length === 0" class="alert alert-info">
      No hay canciones votadas todavía.
    </div>

    <div *ngFor="let song of songs; let i = index" class="card mb-2">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-1 text-center">
            <span class="badge bg-primary rounded-pill">{{ i + 1 }}</span>
          </div>
          <div class="col-2">
            <img [src]="song.image" class="img-fluid rounded" [alt]="song.name">
          </div>
          <div class="col-5">
            <h6 class="mb-1">{{ song.name }}</h6>
            <p class="text-muted mb-1 small">{{ song.artists.join(', ') }}</p>
            <div class="d-flex gap-2">
              <span class="badge bg-success">
                <i class="fas fa-thumbs-up me-1"></i>{{ song.votes || 0 }}
              </span>
              <span class="badge bg-danger">
                <i class="fas fa-thumbs-down me-1"></i>{{ song.dislikes || 0 }}
              </span>
            </div>
          </div>
          <div class="col-2">
            <small class="text-muted">Agregada: {{ formatTimeAgo(song.createdat) }}</small>
          </div>
          <div class="col-2 text-end">
            <button class="btn btn-success btn-sm me-1" (click)="addToQueue('spotify:track:' + song.id)">
              <i class="fas fa-plus"></i> Cola
            </button>
            <button class="btn btn-danger btn-sm me-1" (click)="deleteSong(song.id)">
              <i class="fas fa-trash me-1"></i>Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>